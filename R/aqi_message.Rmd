---
title: ''
output:
  html_fragment:
    keep_md: false
    self_contained: no
---

## Minnesota AQI report   

<div style="margin-top: -15px;"> <i>Preliminary results for `r format(Sys.Date() - 1, "%A %b %d, %Y")`</i></div>  
  
```{r echo=FALSE, message = FALSE, warning = FALSE}
#devtools::install_github("renkun-ken/formattable")
library(formattable)
library(tidyverse)
library(lubridate)
library(ggrepel)
library(gridExtra)

days_past <- 0

# Test for weekend
weekend <- weekdays(Sys.Date() - 1 - days_past) %in% c("Sunday","Monday")


# Test for Ozone season
ozone_season <- as.numeric(format(Sys.Date(), "%m")) %in% 4:10


# AQI conversion functions
source("X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/Staff Folders/Dorian/AQI/Web/aqi-watch/R/aqi_convert.R")


#-- Load yesterdays observations

#verify <- readRDS(paste0("Archive/", Sys.Date() - days_past, "_verification_table.Rdata"))
verify <- read_csv("X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/Staff Folders/Dorian/AQI/Verification/2017_verification_table.csv")


# Switch Voyageurs AQS ID
verify[verify$site_catid == "27-137-0034", "site_catid"] <- "27-137-9000"


#-- Filter to yesterdays results
verify <- filter(verify, forecast_date == Sys.Date() - days_past - 1)


#-- Remove day0 forecast from report
verify <- filter(verify, forecast_day != 0)


#-- Filter to most recent forecast
verify <- verify %>% 
            group_by(site_catid) %>% 
            filter(forecast_day == min(forecast_day, na.rm = T)) %>%
            ungroup()


#-- Select one forecast per site
verify <- verify[!duplicated(verify$site_catid), ]

#-- Recalculate AQI
verify$obs_pm25_aqi <- conc2aqi(verify$obs_pm25_ugm3, "pm25")


# Check for color only forecasts, if found set "weekend" to TRUE
if ("green" %in% c(verify$fcst_ozone_aqi, verify$fcst_pm25_aqi) | 
    "yellow" %in% c(verify$fcst_ozone_aqi, verify$fcst_pm25_aqi) | 
    "orange" %in% c(verify$fcst_ozone_aqi, verify$fcst_pm25_aqi)) weekend <- TRUE


# If weekend convert forecast color to AQI
if (weekend) verify <- verify %>% 
                         rowwise() %>% 
                         mutate(fcst_ozone_aqi = ifelse(!fcst_ozone_aqi %in% c("green", "yellow", "orange"), 
                                                         as.numeric(fcst_ozone_aqi),
                                                         cat2aqi(fcst_ozone_aqi)),
                                fcst_pm25_aqi  = ifelse(!fcst_pm25_aqi %in% c("green", "yellow", "orange"),
                                                         as.numeric(fcst_pm25_aqi),
                                                         cat2aqi(fcst_pm25_aqi)))


# Set forecast to numeric
verify <- mutate(verify, 
                 fcst_ozone_aqi = as.numeric(fcst_ozone_aqi),
                 fcst_pm25_aqi  = as.numeric(fcst_pm25_aqi))


#-- Add baseline predictions
source("../aircast/R/run_baseline_predictions.R")

verify <- left_join(verify, select(blend3, -short_name)) %>% ungroup()


#-- Dates
fcast_date <- Sys.Date() - 1 - as.numeric(gsub("day", "", verify$forecast_day[1]))

cmaq_date  <- fcast_date


#-- Change column name to match CMAQ
names(verify)[grep("site_catid", names(verify))] <- "aqs_id"


#-- If forecast day above day1, load CMAQ separately
if (verify$forecast_day[1] != "day1" & ozone_season) {
  
  cmaq   <- read_csv(paste0("X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/Staff Folders/Dorian/AQI/Current forecast/", Sys.Date() - 2, "_CMAQ_forecast.csv"))
  
  names(cmaq)[grep("cmaq_day1_max_ozone_8hr", names(cmaq))] <- "cmaq_ozone_aqi"
  names(cmaq)[grep("site_catid", names(cmaq))] <- "aqs_id"
  
  verify     <- left_join(select(verify, -cmaq_ozone_aqi), select(cmaq, aqs_id, cmaq_ozone_aqi))
  
  cmaq_date  <- Sys.Date() - 2
}


#-- Select columns for report
verify <- select(verify, short_name, group, aqs_id,
                 count_ozone_obs, obs_ozone_ppb, obs_ozone_aqi, fcst_ozone_aqi, mod_aqi_o3, cmaq_ozone_aqi, 
                 persist_ozone_aqi, roll_ozone_aqi, roll11_ozone_aqi, bb3_ozone_aqi,
                 count_pm25_obs, obs_pm25_ugm3, obs_pm25_aqi, fcst_pm25_aqi, mod_aqi_pm,
                 persist_pm25_aqi, roll_pm25_aqi, roll11_pm25_aqi, bb3_pm25_aqi)


names(verify)[1:3] <- c("Site", "Group", "AQS ID") 


#-- Clip long site names
verify$Site <- ifelse(verify$Site == "Duluth_WDSE", "Duluth WD", verify$Site)
verify$Site <- ifelse(verify$Site == "St_Paul_Ramsey_Health", "St Paul Ramsey", verify$Site)
verify$Site <- ifelse(verify$Site == "MSP_HC_Anderson", "HC Anderson", verify$Site)
verify$Site <- ifelse(verify$Site == "MSP_St_Louis_Park", "St Louis Park", verify$Site)


# Remove underscores from names
verify$Site  <- gsub("_", " ", verify$Site)
verify$Group <- gsub("_", " ", verify$Group)


#-- Select highest forecast per group
verify_pm <- verify %>%
              group_by(Group) %>%
              arrange(-obs_pm25_ugm3) %>%
              mutate(obs_ozone_ppb    = NA,
                     obs_ozone_aqi    = NA,
                     obs_pm25_ugm3    = max(obs_pm25_ugm3, na.rm = T),
                     obs_pm25_aqi     = max(obs_pm25_aqi, na.rm = T),
                     #fcst_pm25_ugm3  = max(fcst_pm25_ugm3, na.rm = T),                             
                     fcst_pm25_aqi    = max(fcst_pm25_aqi, na.rm = T),
                     mod_aqi_o3       = max(mod_aqi_o3, na.rm = T),
                     #mod_pm25avg     = max(mod_pm25avg, na.rm = T),                                
                     mod_aqi_pm       = max(mod_aqi_pm, na.rm = T),
                     persist_pm25_aqi = max(persist_pm25_aqi, na.rm = T),
                     roll_pm25_aqi    = max(roll_pm25_aqi , na.rm = T),
                     roll11_pm25_aqi  = max(roll11_pm25_aqi, na.rm = T),
                     bb3_pm25_aqi     = max(bb3_pm25_aqi, na.rm = T),
                     count           = 1:n()) %>%
             filter(count == 1) %>%
             select(-count) %>%
             ungroup()

names(verify_pm)[4:ncol(verify_pm)] <-  c("Ozone obs count", "Ozone ppb", "Ozone AQI", "Ozone forecast", "Ozone model output", "CMAQ forecast",
                   "persist_ozone_aqi", "roll_ozone_aqi", "roll11_ozone_aqi", "bb3_ozone_aqi",
                   "PM2.5 obs count", "PM2.5 ug/m3", "PM2.5 AQI", "PM2.5 forecast", "PM2.5 model output",
                   "persist_pm25_aqi", "roll_pm25_aqi", "roll11_pm25_aqi", "bb3_pm25_aqi")

verify_o3 <- verify %>%
              group_by(Group) %>%
              arrange(-obs_ozone_ppb) %>%
              mutate(obs_pm25_ugm3     = NA,
                     obs_pm25_aqi      = NA,
                     obs_ozone_ppb     = max(obs_ozone_ppb, na.rm = T),
                     obs_ozone_aqi     = max(obs_ozone_aqi, na.rm = T),
                     #fcst_ozone_ppb   = max(fcst_ozone_ppb, na.rm = T), 
                     fcst_ozone_aqi    = max(fcst_ozone_aqi, na.rm = T),
                     #mod_max_avg8hr   = max(mod_max_avg8hr, na.rm = T),
                     mod_aqi_o3        = max(mod_aqi_o3, na.rm = T),
                     #cmaq_ozone_ppb   = max(cmaq_ozone_ppb, na.rm = T),
                     cmaq_ozone_aqi    = max(cmaq_ozone_aqi, na.rm = T),
                     persist_ozone_aqi = max(persist_pm25_aqi, na.rm = T),
                     roll_ozone_aqi    = max(roll_pm25_aqi , na.rm = T),
                     roll11_ozone_aqi  = max(roll11_pm25_aqi, na.rm = T),
                     bb3_ozone_aqi     = max(bb3_pm25_aqi, na.rm = T),
                     count             = 1:n()) %>%
             filter(count == 1) %>%
             select(-count) %>%
             ungroup()



names(verify_o3)[4:ncol(verify_o3)] <-  c("Ozone obs count", "Ozone ppb", "Ozone AQI", "Ozone forecast", "Ozone model output", "CMAQ forecast",
                   "persist_ozone_aqi", "roll_ozone_aqi", "roll11_ozone_aqi", "bb3_ozone_aqi",
                   "PM2.5 obs count", "PM2.5 ug/m3", "PM2.5 AQI", "PM2.5 forecast", "PM2.5 model output",
                   "persist_pm25_aqi", "roll_pm25_aqi", "roll11_pm25_aqi", "bb3_pm25_aqi")


# Join together
verify <- bind_rows(verify_pm, verify_o3)

verify[verify == -Inf] <- NA
verify_o3[verify_o3 == -Inf] <- NA
verify_pm[verify_pm == -Inf] <- NA


# Ozone table
verify_o3 <- select(verify_o3, -c(`AQS ID`, `PM2.5 obs count`, `PM2.5 ug/m3`,  `PM2.5 AQI`, `PM2.5 forecast`, `PM2.5 model output`, persist_pm25_aqi, roll_pm25_aqi, roll11_pm25_aqi, bb3_pm25_aqi)) %>% 
             filter(!is.na(`Ozone forecast`), !is.na(`Ozone AQI`)) %>%
             arrange(-`Ozone AQI`)

names(verify_o3)[3:8] <- c("Obs count", "conc", "Obs AQI", "MPCA forecast", "Model output", "CMAQ forecast")


# PM2.5 table
verify_pm <- select(verify_pm, c(Site, Group, `PM2.5 obs count`, `PM2.5 ug/m3`, `PM2.5 AQI`, `PM2.5 forecast`, `PM2.5 model output`, persist_pm25_aqi, roll_pm25_aqi, roll11_pm25_aqi, bb3_pm25_aqi)) %>% 
             filter(!is.na(`PM2.5 forecast`), !is.na(`PM2.5 AQI`)) %>%
             arrange(-`PM2.5 AQI`)

names(verify_pm)[3:7] <- c("Obs count", "conc", "Obs AQI", "MPCA forecast", "Model output")


# Plot accuracy
# Flip to tall table
tall_o3 <- tidyr::gather(data  = select(verify_o3, -conc),
                         key   = model, 
                         value = aqi, 
                         na.rm = FALSE, 
                         `Obs AQI`, `MPCA forecast`, `Model output`, `CMAQ forecast`, persist_ozone_aqi, roll_ozone_aqi, roll11_ozone_aqi, bb3_ozone_aqi)


tall_pm <- tidyr::gather(data  = select(verify_pm, -conc),
                         key   = model, 
                         value = aqi, 
                         na.rm = FALSE, 
                         `Obs AQI`, `MPCA forecast`, `Model output`, persist_pm25_aqi, roll_pm25_aqi, roll11_pm25_aqi, bb3_pm25_aqi)


# Set colors
tall_o3 <- tall_o3 %>% 
           rowwise() %>%
           mutate(background_color = aqi2color(aqi))

tall_pm <- tall_pm %>% 
           rowwise() %>%
           mutate(background_color = aqi2color(aqi))

# Convert to concentration
tall_o3 <- tall_o3 %>% 
           rowwise() %>% 
           mutate(conc = aqi2conc(aqi, "OZONE")) %>%
           group_by(Site) %>%
           mutate(`conc_diff (ppb)` = conc - conc[model == "Obs AQI"],
                  fcst_correct = identical(background_color[model == "Obs AQI"], background_color[model == "MPCA forecast"]))
        

tall_pm <- tall_pm %>% 
           rowwise() %>% 
           mutate(conc = aqi2conc(aqi, "PM25")) %>%
           group_by(Site) %>%
           mutate(`conc_diff (ug/m3)` = conc - conc[model == "Obs AQI"],
                  fcst_correct = identical(background_color[model == "Obs AQI"], background_color[model == "MPCA forecast"]))
            
```
  
  
```{r echo=FALSE, message=FALSE, warning=FALSE, results='hide', fig.width=6, fig.height=6, fig.show='hide'}
  
# Order sites
tall_o3$Site <- factor(tall_o3$Site, levels = rev(arrange(filter(tall_o3, model == "Obs AQI"), -conc)$Site))

tall_pm$Site <- factor(tall_pm$Site, levels = rev(arrange(filter(tall_pm, model == "Obs AQI"), -conc)$Site))


# Regression line plot

# Add AQI colors
verify_o3 <-  verify_o3 %>%
              rowwise() %>%
              mutate(pollutant = "Ozone",
                     background_color = aqi2color(`Obs AQI`))

verify_pm <-  verify_pm %>%
              rowwise() %>%
              mutate(pollutant = "PM2.5",
                     background_color = aqi2color(`Obs AQI`))

# Combine tables
verify_all <- bind_rows(verify_o3, verify_pm)

verify_all <- verify_all %>%
              rowwise() %>%
              mutate(`Obs conc`   = if_else(is.na(conc), aqi2conc(as.numeric(`Obs AQI`), pollutant), conc), 
                     `MPCA conc`  = aqi2conc(as.numeric(`MPCA forecast`), pollutant), 
                     `Model conc` = aqi2conc(as.numeric(`Model output`), pollutant), 
                     `CMAQ conc`  = aqi2conc(as.numeric(`CMAQ forecast`), pollutant)) %>%
              select(-conc)


if (!weekend) {
#-- Plot limits
ozone_range <- range(filter(verify_all, pollutant == "Ozone")[ , c("Obs conc", "MPCA conc")], na.rm = T)

pm_range    <- range(filter(verify_all, pollutant == "PM2.5")[ , c("Obs conc", "MPCA conc")], na.rm = T)


#-- ggplot
o3_line_plot <- filter(verify_all, !is.na(`Obs conc`), pollutant == "Ozone") %>%
                ggplot(aes(x = `Obs conc`, y = `MPCA conc`)) + 
                  geom_abline(intercept = 0, size = 0.25, color = "grey50") +
                  geom_abline(intercept = 5, size = 0.25, color = "grey50", linetype = 3) +
                  geom_abline(intercept = -5, size = 0.25, color = "grey50", linetype = 3) +
                  geom_point(colour = "grey50", size = 1.75) +
                  geom_point(aes(color = factor(background_color)), size = 1.6) + 
                  geom_text_repel(aes(label = Site), size = 1.75) + 
                  scale_color_manual(values = levels(factor(tall_o3$background_color)), guide = F) +
                  ylim(ozone_range) +
                  xlim(ozone_range) +
                  theme_bw() + 
                  theme_gray(base_size = 5) +
                  theme(aspect.ratio  = 1, 
                        plot.margin   = unit(c(0,0.5,0,0), "lines"),
                        plot.title    = element_text(size = 7.5, color = "grey20"),
                        panel.grid.major = element_line(color = "grey94", size = 0.3),
                        panel.grid.minor = element_line(color = "grey96", size = 0.25),
                        panel.background = element_rect(fill = "grey99"),
                        axis.ticks    = element_blank(),
                        axis.text.x   = element_text(size = 5),
                        axis.title.x  = element_text(size = 5),
                        axis.text.y   = element_text(size = 5),
                        axis.title.y  = element_text(size = 5)) +
                  labs(title = "Ozone (ppb)", x = "Monitored", y = "MPCA forecast")


pm_line_plot <- filter(verify_all, !is.na(`Obs conc`), pollutant == "PM2.5") %>%
                ggplot(aes(x = `Obs conc`, y = `MPCA conc`)) + 
                  geom_abline(intercept = 0, size = 0.25, color = "grey50") +
                  geom_abline(intercept = 3, size = 0.25, color = "grey50", linetype = 3) +
                  geom_abline(intercept = -3, size = 0.25, color = "grey50", linetype = 3) +
                  geom_point(colour = "grey50", size = 1.75) +
                  geom_point(aes(color = factor(background_color)), size = 1.6) + 
                  geom_text_repel(aes(label = Site), size = 1.75) + 
                  scale_color_manual(values = levels(factor(tall_pm$background_color)), guide = F) +
                  ylim(pm_range) +
                  xlim(pm_range) +
                  theme_bw() + 
                  theme_gray(base_size = 5) + 
                  theme(aspect.ratio  = 1, 
                        plot.margin   = unit(c(0,0.5,0,0), "lines"),
                        plot.title    = element_text(size = 7.5, color = "grey20"),
                        panel.grid.major = element_line(color = "grey94", size = 0.3),
                        panel.grid.minor = element_line(color = "grey96", size = 0.25),
                        panel.background = element_rect(fill = "grey99"),
                        axis.ticks    = element_blank(),
                        axis.text.x   = element_text(size = 5),
                        axis.title.x  = element_text(size = 5),
                        axis.text.y   = element_text(size = 5),
                        axis.title.y  = element_text(size = 5)) +
                  labs(title = "PM2.5 (ug/m3)", x = "Monitored", y = "MPCA forecast")


if (ozone_season) {
  # Save to PNG image
  png("C:/Users/dkvale/Desktop/fcst_regression.png", width = 1300, height = 700, res = 300)
  # Set 2 plots per row
  grid.arrange(o3_line_plot, pm_line_plot, ncol = 2) #print(line_plot + theme_gray(base_size = 4.5))
  dev.off()
  
  png("fcst_regression.png", width = 1300, height = 700, res = 300)
  # Set 2 plots per row
  grid.arrange(o3_line_plot, pm_line_plot, ncol = 2) #print(line_plot + theme_gray(base_size = 4.5))
  dev.off()

} else {
  # Save to PNG image
  png("C:/Users/dkvale/Desktop/fcst_regression.png", width = 800, height = 820, res = 300)
  grid.arrange(pm_line_plot, ncol = 1) #print(line_plot + theme_gray(base_size = 4.5))
  dev.off()
  
  png("fcst_regression.png", width = 800, height = 820, res = 300)
  grid.arrange(pm_line_plot, ncol = 1) #print(line_plot + theme_gray(base_size = 4.5))
  dev.off()
}

}

verify_o3$background_color <- NULL
verify_pm$background_color <- NULL

```
  
```{r echo=FALSE, message =FALSE, warning =FALSE, results='hide'}
# Leader board
#lead_board <- data_frame(Model              = c("Staniel Dirwin", "Dr Robot", "CMAQ"),
#                         `O3 accuracy (%)`  = c(100,100,100),
#                         `PM accuracy (%)`  = c(100,100,100),
#                         `O3 bias (ppb)`    = c(5,5,5),
#                         `PM bias (ug/m3)`  = c(1,1,1),
#                         `Forecasts (n)`    = c(0,0,0)) 
                             

# Load past results
#lead_board <- read_csv("X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/Staff folders/Dorian/AQI/Verification/lead_board.csv")

lead_board <- try(read_csv(paste0("X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/Staff folders/Dorian/AQI/Verification/Archive leaders/", Sys.Date() - 1, "-lead_board.csv")))


if (class(lead_board) == "try-error") {
  
   lead_board <- read_csv(paste0("X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/Staff folders/Dorian/AQI/Verification/Archive leaders/", Sys.Date() - 2, "-lead_board.csv"))
   
}

# New performance metrics
o3_performance <- tall_o3 %>%
                     group_by(Site) %>%
                     mutate(n            = 1:n(),
                            obs_col      = background_color[model == "Obs AQI"],
                            obs_conc     = conc[model == "Obs AQI"],
                            fcst_correct = obs_col == background_color[n],
                            conc_diff    = abs(obs_conc - conc[n])) %>%
                     group_by(model) %>%
                     summarize(n_obs          = sum(!is.na(tall_o3$aqi[tall_o3$model == "Obs AQI"])),
                               n_preds        = sum(!is.na(fcst_correct)),
                               elev_preds     = sum(!is.na(fcst_correct) & obs_col != "#53BF33"), 
                               accuracy       = 100 * sum(fcst_correct, na.rm = T) / n_preds,
                               elev_accuracy  = 100 * sum(fcst_correct & obs_col != "#53BF33", na.rm = T) / elev_preds, 
                               mean_conc_diff = mean(conc_diff, na.rm = T),
                               bulls_eyes     = 100 * sum(conc_diff <= 5, na.rm = T) / n_preds,
                               near_misses    = 100 * sum(conc_diff <= 10, na.rm = T) / n_preds) %>%
                     arrange(desc(model))


pm_performance <- tall_pm %>%
                     group_by(Site) %>%
                     mutate(n            = 1:n(),
                            obs_col      = background_color[model == "Obs AQI"],
                            obs_conc     = conc[model == "Obs AQI"],
                            fcst_correct = obs_col == background_color[n],
                            conc_diff    = abs(obs_conc - conc[n])) %>%
                     group_by(model) %>%
                     summarize(n_obs          = sum(!is.na(tall_pm$aqi[tall_pm$model == "Obs AQI"])),
                               n_preds        = sum(!is.na(fcst_correct)),
                               elev_preds     = sum(!is.na(fcst_correct) & obs_col != "#53BF33"), 
                               accuracy       = 100 * sum(fcst_correct, na.rm = T) / n_preds,
                               elev_accuracy  = 100 * sum(fcst_correct & obs_col != "#53BF33", na.rm = T) / elev_preds, 
                               mean_conc_diff = mean(conc_diff, na.rm = T),
                               bulls_eyes     = 100 * sum(conc_diff <= 2.5, na.rm = T) / n_preds,
                               near_misses    = 100 * sum(conc_diff <= 5, na.rm = T) / n_preds) %>%
                     arrange(desc(model))


## New performance table
yest_board <- data_frame(Model                   = c("Staniel Dirwin", "Dr Robot", "CMAQ", "Farmer Weeks", "Persistant Assistant","J.K. Rollings", "BB3 (aka 'Blender')"),
                        `new O3 accuracy`         = o3_performance$accuracy[c(5:7,1,3,2,8)],
                        `new O3 yellow accuracy`  = o3_performance$elev_accuracy[c(5:7,1,3,2,8)],
                        `new O3 bias (ppb)`       = o3_performance$mean_conc_diff[c(5:7,1,3,2,8)],
                        `new O3 bullseyes`        = o3_performance$bulls_eyes[c(5:7,1,3,2,8)],
                        `new O3 on target`        = o3_performance$near_misses[c(5:7,1,3,2,8)],
                        `new PM accuracy`         = pm_performance$accuracy[c(5:6,NA,1,3,2,7)],
                        `new PM yellow accuracy`  = pm_performance$elev_accuracy[c(5:6,NA,1,3,2,7)],
                        `new PM bias (ug/m3)`     = pm_performance$mean_conc_diff[c(5:6,NA,1,3,2,7)],
                        `new PM bullseyes`        = pm_performance$bulls_eyes[c(5:7,1,3,2,7)],
                        `new PM on target`        = pm_performance$near_misses[c(5:7,1,3,2,7)],
                         new_obs                  = 1)


# Don't update annual stats on Sunday and Monday
if (!weekend) {
  
  # Update performance
  lead_board <- left_join(yest_board, lead_board)
  
  # Don't update Ozone in winter
  if (!ozone_season) {
    
     lead_board$new_obs[3] <- 0
    
     lead_board <- lead_board %>% 
                   rowwise() %>%
                   mutate(`Forecasts (n)`    = sum(`Forecasts (n)`, new_obs, na.rm = T),
                          
                          `PM cat accuracy (%)`  = sum(`PM cat accuracy (%)` * (`Forecasts (n)` - new_obs), `new PM accuracy` * new_obs, na.rm = T) / max(1, `Forecasts (n)`, na.rm = T),
                          
                       `PM yellow accuracy (%)` = ifelse(is.na(`new PM yellow accuracy`), `PM yellow accuracy (%)`, sum( `PM yellow accuracy (%)` * (`Forecasts (n)` - new_obs), `new PM yellow accuracy` * new_obs, na.rm = T) / max(1, `Forecasts (n)`, na.rm = T)),
                          
                          `PM bullseyes (%)` = sum(`PM bullseyes (%)` * (`Forecasts (n)` - new_obs), `new PM bullseyes` * new_obs, na.rm = T) / max(1, `Forecasts (n)`, na.rm = T),
                          
                          `PM on target (%)` = sum(`PM on target (%)` * (`Forecasts (n)` - new_obs), `new PM on target` * new_obs, na.rm = T) / max(1, `Forecasts (n)`, na.rm = T),

                          `PM bias (ug/m3)`  = sum(`PM bias (ug/m3)` * (`Forecasts (n)` - new_obs), `new PM bias (ug/m3)` * new_obs, na.rm = T) / max(1, `Forecasts (n)`, na.rm = T))
                          
  } else {
    
     lead_board <- lead_board %>% 
                rowwise() %>%
                mutate(`Forecasts (n)`    = sum(`Forecasts (n)`, new_obs, na.rm = T),
                          
                          `PM cat accuracy (%)`  = sum(`PM cat accuracy (%)` * (`Forecasts (n)` - new_obs), `new PM accuracy` * new_obs, na.rm = T) / max(1, `Forecasts (n)`, na.rm = T),
                       
                          `PM yellow accuracy (%)` = ifelse(is.na(`new PM yellow accuracy`), `PM yellow accuracy (%)`, sum( `PM yellow accuracy (%)` * (`Forecasts (n)` - new_obs), `new PM yellow accuracy` * new_obs, na.rm = T) / max(1, `Forecasts (n)`, na.rm = T)),
                          
                          `PM bullseyes (%)` = sum(`PM bullseyes (%)` * (`Forecasts (n)` - new_obs), `new PM bullseyes` * new_obs, na.rm = T) / max(1, `Forecasts (n)`, na.rm = T),
                          
                          `PM on target (%)` = sum(`PM on target (%)` * (`Forecasts (n)` - new_obs), `new PM on target` * new_obs, na.rm = T) / max(1, `Forecasts (n)`, na.rm = T),

                          `PM bias (ug/m3)`  = sum(`PM bias (ug/m3)` * (`Forecasts (n)` - new_obs), `new PM bias (ug/m3)` * new_obs, na.rm = T) / max(1, `Forecasts (n)`, na.rm = T),
                          
                          `O3 cat accuracy (%)`  = sum(`O3 cat accuracy (%)` * (`Forecasts (n)` - new_obs), `new O3 accuracy` * new_obs, na.rm = T) / max(1, `Forecasts (n)`, na.rm = T),
                       
                          `O3 yellow accuracy (%)` = ifelse(is.na(`new O3 yellow accuracy`), `O3 yellow accuracy (%)`, sum(`O3 yellow accuracy (%)` * (`Forecasts (n)` - new_obs), `new O3 yellow accuracy` * new_obs, na.rm = T) / max(1, `Forecasts (n)`, na.rm = T)),
                          
                          `O3 bullseyes (%)` = sum(`O3 bullseyes (%)` * (`Forecasts (n)` - new_obs), `new O3 bullseyes` * new_obs, na.rm = T) / max(1, `Forecasts (n)`, na.rm = T),
                          
                          `O3 on target (%)` = sum(`O3 on target (%)` * (`Forecasts (n)` - new_obs), `new O3 on target` * new_obs, na.rm = T) / max(1, `Forecasts (n)`, na.rm = T),

                          `O3 bias (ppb)`  = sum(`O3 bias (ppb)` * (`Forecasts (n)` - new_obs), `new O3 bias (ppb)` * new_obs, na.rm = T) / max(1, `Forecasts (n)`, na.rm = T))
     
  }


 
} else {
  yest_board[1, c(4:6,9:11)] <- NA 
}


# Create web table
margin_right <- function(i) {
    formatter("span", style = x ~ style("padding-right"  = paste0(i, "px"),
                                        digits(x, 2)))
}


# Yesterday's performance
yest_board <- select(yest_board, Model, 
                     `new O3 bias (ppb)`, `new O3 on target`, `new O3 bullseyes`, `new O3 accuracy`, `new O3 yellow accuracy`,   
                     `new PM bias (ug/m3)`, `new PM on target`, `new PM bullseyes`, `new PM accuracy`, `new PM yellow accuracy` )
  
# Clean table
names(yest_board) <- gsub("new ", "", names(yest_board))
  
names(yest_board) <-  c("Model",
                        "O3 bias (ppb)", "O3 bullseyes (%)", "O3 on target (%)", "O3 cat accuracy (%)",  "O3 yellow accuracy (%)", 
                        "PM bias (ug/m3)", "PM on target (%)", "PM bullseyes (%)", "PM cat accuracy (%)", "PM yellow accuracy (%)")


yest_board[is.na(yest_board$`PM yellow accuracy (%)`), "PM yellow accuracy (%)"] <- " "

# Add date of forecast  
#yest_board <- cbind(yest_board, data_frame("Date of forecast" = c(fcast_date, fcast_date, cmaq_date, rep(NA, 4))))
  
if (ozone_season) {
  yest_board <- formattable(yest_board,
                            list(Model                     = margin_right(24),
                                 `O3 on target (%)`        = margin_right(110),
                                 `O3 cat accuracy (%)`     = margin_right(104),
                                 `O3 yellow accuracy (%)`  = margin_right(124),
                                 `O3 bullseyes (%)`        = margin_right(114),
                                 `O3 bias (ppb)`           = margin_right(84),
                                 `PM on target (%)`        = margin_right(110),
                                 `PM cat accuracy (%)`     = margin_right(110),
                                 `PM yellow accuracy (%)`  = margin_right(124),
                                 `PM bullseyes (%)`        = margin_right(114),
                                 `PM bias (ug/m3)`         = margin_right(100)),
                            align = c("l"), digits = 2)
} else{

  yest_board <- formattable(select(yest_board[-3, ], -c(`O3 cat accuracy (%)`, `O3 yellow accuracy (%)`, `O3 bullseyes (%)`, `O3 on target (%)`, `O3 bias (ppb)`)),
                            list(Model                     = margin_right(24),
                                 `PM cat accuracy (%)`     = margin_right(110),
                                 `PM yellow accuracy (%)`  = margin_right(124),
                                 `PM bullseyes (%)`        = margin_right(114),
                                 `PM on target (%)`        = margin_right(110),
                                 `PM bias (ug/m3)`         = margin_right(100)),
                            align = c("l"), digits = 2) 
  
}

# Total running performance
lead_board <- select(lead_board, c(Model, `O3 bias (ppb)`, `O3 on target (%)`, `O3 bullseyes (%)`, `O3 cat accuracy (%)`, `O3 yellow accuracy (%)`,
                                   `PM bias (ug/m3)`), `PM on target (%)`, `PM bullseyes (%)`, `PM cat accuracy (%)`, `PM yellow accuracy (%)`,   `Forecasts (n)`)


# Archive updated performance
write_csv(lead_board, "X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/Staff folders/Dorian/AQI/Verification/lead_board.csv")

# Backup file
write_csv(lead_board, paste0("X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/Staff folders/Dorian/AQI/Verification/Archive leaders/", Sys.Date(), "-lead_board.csv"))

if (ozone_season) {
  lead_board <- formattable(lead_board,
                            list(Model                     = margin_right(24),
                                 `O3 on target (%)`        = margin_right(110),
                                 `O3 cat accuracy (%)`     = margin_right(104),
                                 `O3 yellow accuracy (%)`  = margin_right(124),
                                 `O3 bullseyes (%)`        = margin_right(114),
                                 `O3 bias (ppb)`           = margin_right(84),
                                 `PM on target (%)`        = margin_right(110),
                                 `PM cat accuracy (%)`     = margin_right(110),
                                 `PM yellow accuracy (%)`  = margin_right(124),
                                 `PM bullseyes (%)`        = margin_right(114),
                                 `PM bias (ug/m3)`         = margin_right(100)),
                            align = c("l"), digits = 2)

} else{
  
  lead_board <- formattable(select(lead_board[-3, ], -c(`O3 bias (ppb)`, `O3 on target (%)`, `O3 bullseyes (%)`, `O3 cat accuracy (%)`, `O3 yellow accuracy (%)`)),
                            list(Model                     = margin_right(24),
                                 `PM on target (%)`        = margin_right(110),
                                 `PM cat accuracy (%)`     = margin_right(110),
                                 `PM yellow accuracy (%)`  = margin_right(124),
                                 `PM bullseyes (%)`        = margin_right(114),
                                 `PM bias (ug/m3)`         = margin_right(100)),
                            align = c("l"), digits = 2)
                            
}                           
# Save web tables
saveRDS(yest_board, "yesterday_board.rdata")
saveRDS(lead_board, "leader_board.rdata")

```
  
  
```{r echo=FALSE, message =FALSE, warning =FALSE}

# Update group names
verify_all$Group <- ifelse(verify_all$Group  == "MSP", "MSP-STP", verify_all$Group)

# Add paddding to columns
verify_all$Site <- paste0(verify_all$Site, "    ")

# Web format
margin_left <- function(i) {
  
  formatter("span", style = x ~ style("padding-left"  = paste0(i, "px"),
                                      "color"         = ifelse(is.na(x), "white", "black")))
}


col_format <- function(i, param) {
  
  formatter("span", 
            style = x ~ style("padding-left"     = "36px",
                              "padding-right"    = "36px",
                              "margin-right"     = paste0(i, "px"),
                              "font-weight"      = 600,
                              "background-color" = conc2color(x, param),
                              "color"            = if(!weekend) ifelse(is.na(x), "white", "black") else conc2color(x, param),
                              digits(x, 2)
                              )
                    )
}

col_mon_format <- function(i, param) {
  
  formatter("span", 
            style = x ~ style("padding-left"     = "36px",
                              "padding-right"    = "36px",
                              "margin-right"     = paste0(i, "px"),
                              "font-weight"      = 600,
                              "background-color" = conc2color(x, param),
                              "color"            = ifelse(is.na(x), "white", "black"),
                              digits(x, 2)
                              )
                    )
}


verify_all <- verify_all[ , c(1:7,12:13,18:21)]

names(verify_all) <- c("Site", "Group", "Obs count", "Obs AQI", "MPCA AQI", "Model AQI", "CMAQ AQI", "pollutant", "background_color", "Monitored", "MPCA fcast", "Model output", "CMAQ fcast")


# Drop model output value unless different than MPCA forecast
if (!weekend) verify_all$`Model output` <- ifelse(verify_all$`MPCA fcast` == verify_all$`Model output`, NA, verify_all$`Model output`)


# Save web tables
# Ozone
verify_o3 <- formattable(filter(verify_all, pollutant == "Ozone")[ , -c(2,4:9)],
                         list(Site            = margin_right(23),
                              #Group          = margin_right(20),
                              `Obs count`     = margin_right(65),
                              Monitored       = col_mon_format(15, "ozone"),
                              `MPCA fcast`    = col_format(15, "ozone"),
                              `Model output`  = col_mon_format(15, "ozone"),
                              `CMAQ fcast`    = col_mon_format(15, "ozone")),
                          align = c("l","l","l","l","l","l","l"), digits = 1)

saveRDS(verify_o3, "o3_table.rdata")


# PM table
verify_pm <- formattable(filter(verify_all, pollutant == "PM2.5")[ , -c(2,4:9,13)],
                         list(Site            = margin_right(23),
                              #Group          = margin_right(20),
                              `Obs count`     = margin_right(65),
                              `Monitored`     = col_mon_format(15, "pm25"),
                              `MPCA fcast`    = col_format(15, "pm25"),
                              `Model output`  = col_mon_format(15, "pm25")),
                          align = c("l","l","l","l","l","l"), digits = 1)

saveRDS(verify_pm, "pm_table.rdata")
```
  
  
<div style="margin-top: 20px;">
### Yesterday&#39;s model performance   
</div>

<div style="margin-top: -10px;">

```{r, echo=F, warning=F, message=F, results="asis"}

options(warn = -1)

cat(paste0('\nThe category accuracy of the next-day forecast was __', round(pm_performance[5, ]$accuracy), '%__ (', sum(filter(tall_pm, !is.na(aqi), model == 'MPCA forecast')$fcst_correct, na.rm = T), '/', pm_performance[1, ]$n_preds, ') for PM2.5'))

if (ozone_season) { 
  cat(paste0(' and __', round(o3_performance[5, ]$accuracy), '%__ (', sum(filter(tall_o3, !is.na(aqi), model == 'MPCA forecast')$fcst_correct, na.rm = T), '/', o3_performance[1, ]$n_preds, ') for ozone'))
  }

cat(". \n")

```

</div>
  

<div style="margin-top: -8px; margin-left: 24px;">
```{r, echo = F, warning = F, message = F}
yest_board <- readRDS('yesterday_board.rdata')
yest_board[1, 1] <- "STAV Brodirwin"
yest_board[6, 1] <- "BB3 (the Blender)"
yest_board
```

```{r echo=F, warning=F, message=F, results="asis"}

if (weekend) { cat('\n\n_Note: Some of MPCA&#39;s forecasts only predicted the AQI color so the bias estimate could not be calculated._' )}
``` 
</div>

  
### Overall model performance for next-day forecasts

<div style="margin-top: -11px;">
Look out for some new contenders. The competition is growing.
</div>


<div style="margin-top: -2px; margin-left: 24px;">
```{r, echo = F, warning = F, message = F}
#Dr-Robot is getting smarter everyday.
lead_board <- readRDS('leader_board.rdata') 
lead_board[1, 1] <- "STAV Brodirwin"
lead_board[6, 1] <- "BB3 (the Blender)"

# Round values
lead_board$`PM yellow accuracy (%)` <- round(lead_board$`PM yellow accuracy (%)`)
if (grepl("O3", names(lead_board))) lead_board$`O3 yellow accuracy (%)` <- round(lead_board$`O3 yellow accuracy (%)`)
lead_board
```
</div>
  

```{r echo=F, eval=T, results="asis"}

out <- ''

if (!ozone_season) {
 
  if (!weekend) {  
    
out <- '\n
### MPCA forecast vs Monitored actuals  \n

<div style = "margin-top: -16px; margin-left: 8px;">
<img src="fcst_regression.png" width="440" height="450" style="margin-right: 1200px; margin-bottom: 15px; margin-left: 8px;"> 
</div>'
    
  }
} else {
  
if (!weekend) {   
out <- '\n 
### MPCA forecast vs Monitored actuals \n

<div style = "margin-top: -18px; margin-left: 8px;">
<img src="fcst_regression.png" width="1000" height="500"> 
</div> <br>'
  }
  
out <- paste0(out, 
'<div style="margin-top: -12px"> \n

### Ozone results in _ppb_ \n
    
</div>
    
<div style="margin-top: -18px; margin-left: 18px;">
    
o3_df <- readRDS("o3_table.rdata")
o3_df
</div> \n
', collapse = "\n")
} 
   
cat(out)
```


### PM2.5 results in _ug/m3_ 

<div style="margin-top: -18px; margin-left: 18px;">
```{r, echo = F, warning = F, message = F}
pm_df <- readRDS('pm_table.rdata')
pm_df
```
</div>
  
