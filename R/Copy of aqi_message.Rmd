---
title: ''
output:
  html_fragment:
    keep_md: false
    self_contained: no
---


## Minnesota AQI report  
<div style="margin-top: -15px;"> <i>Preliminary results for `r format(Sys.Date() - 1, "%A %b %d, %Y")`</i></div>  
  
```{r echo=FALSE, message =FALSE, warning =FALSE}
#devtools::install_github("renkun-ken/formattable")
library(formattable)
library(dplyr)
library(readr)
library(tidyr)
library(lubridate)
library(ggplot2)
library(ggrepel)
library(gridExtra)


days_past <- 0

# AQI conversion functions
source("X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/Staff Folders/Dorian/AQI/Web/aqi-watch/R/aqi_convert.R")

#-- Load credentials
creds <- read.csv("C:\\Users\\dkvale\\Desktop\\credentials.csv", stringsAsFactors = F)

#-- Load yesterdays observations
#saveRDS(all_verify, paste0("Archive/test_", Sys.Date() - days_past, "_verification_table.Rdata"))
#verify <- readRDS(paste0("Archive/", Sys.Date() - days_past, "_verification_table.Rdata"))

verify <- read_csv("X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/Staff Folders/Dorian/AQI/Verification/2017_verification_table.csv")


#-- Filter to yesterdays results
verify <- filter(verify, forecast_date == Sys.Date() - days_past - 1)


#-- Remove day0 forecast from report
verify <- filter(verify, forecast_day != 0)


#-- Filter to most recent forecast
verify <- filter(verify, forecast_day == min(verify$forecast_day, na.rm = T))


#-- Select one forecast per site
verify <- verify[!duplicated(verify$site_catid), ]

names(verify)[grep("site_catid", names(verify))] <- "aqs_id"


#-- Dates
fcast_date <- Sys.Date() - 1 - as.numeric(gsub("day", "", verify$forecast_day[1]))

cmaq_date  <- fcast_date

#-- If forecast day above day1, load CMAQ separately
if(verify$forecast_day[1] != "day1") {
  cmaq   <- read_csv(paste0("X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/Staff Folders/Dorian/AQI/Current forecast/", Sys.Date() - 2, "_CMAQ_forecast.csv"))
  
  names(cmaq)[grep("cmaq_day1_max_ozone_8hr", names(cmaq))] <- "cmaq_ozone_aqi"
  names(cmaq)[grep("site_catid", names(cmaq))] <- "aqs_id"
  
  verify     <- left_join(select(verify, -cmaq_ozone_aqi), select(cmaq, aqs_id, cmaq_ozone_aqi))
  
  cmaq_date  <- Sys.Date() - 2
}
                    
#-- Select columns for report
verify <- select(verify, short_name, group,  aqs_id,
                 count_ozone_obs, obs_ozone_aqi,  fcst_ozone_aqi, mod_aqi_o3, cmaq_ozone_aqi,
                 count_pm25_obs, obs_pm25_aqi, fcst_pm25_aqi, mod_aqi_pm)


names(verify) <- c("Site", "Group", "AQS ID", 
                   "Ozone obs count", "Ozone AQI", "Ozone forecast", "Ozone model output", "CMAQ forecast",
                   "PM2.5 obs count", "PM2.5 AQI", "PM2.5 forecast", "PM2.5 model output")

#-- Clip long site names
verify$Site <- ifelse(verify$Site == "Duluth_WDSE", "Duluth WD", verify$Site)
verify$Site <- ifelse(verify$Site == "St_Paul_Ramsey_Health", "St Paul Ramsey", verify$Site)
verify$Site <- ifelse(verify$Site == "MSP_HC_Anderson", "HC Anderson", verify$Site)
verify$Site <- ifelse(verify$Site == "MSP_St_Louis_Park", "St Louis Park", verify$Site)


# Remove underscores from names
verify$Site <- gsub("_", " ", verify$Site)

verify$Group <- gsub("_", " ", verify$Group)


# Ozone table
verify_o3 <- select(verify, -c(`AQS ID`, `PM2.5 obs count`, `PM2.5 AQI`, `PM2.5 forecast`, `PM2.5 model output`)) %>% 
             filter(!is.na(`Ozone forecast`)) %>%
             arrange(-`Ozone AQI`)

names(verify_o3)[3:7] <- c("Obs count", 
                           "Obs AQI", 
                           "MPCA forecast",
                           "Model output",
                           "CMAQ forecast")

# PM2.5 table
verify_pm <- select(verify, c(Site, Group, `PM2.5 obs count`, `PM2.5 AQI`, `PM2.5 forecast`, `PM2.5 model output`)) %>% 
             filter(!is.na(`PM2.5 forecast`)) %>%
             arrange(-`PM2.5 AQI`)

names(verify_pm)[3:6] <- c("Obs count", 
                           "Obs AQI", 
                           "MPCA forecast",
                           "Model output")

# Plot accuracy
# Flip to tall table
tall_o3 <- tidyr::gather(data   = verify_o3,
                         key   = model, 
                         value = aqi, 
                         na.rm = FALSE, 
                         `Obs AQI`, `MPCA forecast`, `Model output`, `CMAQ forecast`)


tall_pm <- tidyr::gather(data  = verify_pm,
                         key   = model, 
                         value = aqi, 
                         na.rm = FALSE, 
                         `Obs AQI`, `MPCA forecast`, `Model output`)

# Set colors
tall_o3 <- tall_o3 %>% 
           rowwise() %>%
           mutate(background_color = aqi2color(aqi))

tall_pm <- tall_pm %>% 
           rowwise() %>%
           mutate(background_color = aqi2color(aqi))

# Convert to concentration
tall_o3 <- tall_o3 %>% 
           rowwise() %>% 
           mutate(conc = aqi2conc(aqi, "OZONE")) %>%
           group_by(Site) %>%
           mutate(`conc_diff (ppb)` = conc - conc[model == "Obs AQI"],
                  fcst_correct = identical(background_color[model == "Obs AQI"], background_color[model == "MPCA forecast"]))
            
tall_pm <- tall_pm %>% 
           rowwise() %>% 
           mutate(conc = aqi2conc(aqi, "PM25")) %>%
           group_by(Site) %>%
           mutate(`conc_diff (ug/m3)` = conc - conc[model == "Obs AQI"],
                  fcst_correct = identical(background_color[model == "Obs AQI"], background_color[model == "MPCA forecast"]))
            

# Performance metrics

# Ozone
mean_o3_diff <- mean(abs(filter(tall_o3, !is.na(aqi), model == "MPCA forecast")$`conc_diff (ppb)`), na.rm = T) %>%
                round(1)

o3_cat_frx   <- (sum(filter(tall_o3, !is.na(aqi), model == "Obs AQI")$fcst_correct, na.rm = T) / 
                nrow(filter(tall_o3, !is.na(aqi), model == "Obs AQI"))) %>% 
                round(2)

# PM25
mean_pm_diff <- mean(abs(filter(tall_pm, !is.na(aqi), model == "MPCA forecast")$`conc_diff (ug/m3)`), na.rm = T) %>%
                round(1)

pm_cat_frx   <- (sum(filter(tall_pm, !is.na(aqi), model == "Obs AQI")$fcst_correct, na.rm = T) / 
                nrow(filter(tall_pm, !is.na(aqi), model == "Obs AQI"))) %>% 
                round(2)

```
  
```{r echo=FALSE, message=FALSE, warning=FALSE, results='hide', fig.width=6, fig.height=6, fig.show='hide'}

# Order sites
tall_o3$Site <- factor(tall_o3$Site, levels = rev(arrange(filter(tall_o3, model == "Obs AQI"), -conc)$Site))

tall_pm$Site <- factor(tall_pm$Site, levels = rev(arrange(filter(tall_pm, model == "Obs AQI"), -conc)$Site))


if(FALSE) {

# Plots
ggplot(tall_o3, aes(x = `conc_diff (ppb)`, y = Site, shape = model)) + 
   geom_text(aes(label = m_label), colour = "grey50", size = 5.8) +
   geom_text(aes(label = m_label, color = factor(background_color)), size = 5.2) + 
   scale_color_manual(values = levels(factor(tall_o3$background_color)), guide = F) +
   theme_bw() + theme(plot.title = element_text(hjust = 0.5)) + 
   guides(label = guide_legend()) + 
   labs(y = "", title = "c* = CMAQ      m = model output     m- = steve-daniel")

}

# Regression line plot

# Add AQI colors
verify_o3 <-  verify_o3 %>%
              rowwise() %>%
              mutate(pollutant = "Ozone",
                     background_color = aqi2color(`Obs AQI`))

verify_pm <-  verify_pm %>%
              rowwise() %>%
              mutate(pollutant = "PM2.5",
                     background_color = aqi2color(`Obs AQI`))

# Combine tables
verify_all <- bind_rows(verify_o3, verify_pm)

verify_all <- verify_all %>%
              rowwise() %>%
              mutate(`Obs conc`   = aqi2conc(as.numeric(`Obs AQI`), pollutant), 
                     `MPCA conc`  = aqi2conc(as.numeric(`MPCA forecast`), pollutant), 
                     `Model conc` = aqi2conc(as.numeric(`Model output`), pollutant), 
                     `CMAQ conc`  = aqi2conc(as.numeric(`CMAQ forecast`), pollutant)) 

#-- Plot limits
ozone_range <- range(filter(verify_all, pollutant == "Ozone")[ ,c("Obs conc", "MPCA conc")], na.rm = T)

pm_range    <- range(filter(verify_all, pollutant == "PM2.5")[ ,c("Obs conc", "MPCA conc")], na.rm = T)

#-- ggplot
if(FALSE){
all_line_plot <- filter(verify_all, !is.na(`Obs conc`)) %>%
                 ggplot(aes(x = `Obs conc`, y = `MPCA conc`)) + 
                  geom_abline(intercept = 0, size = 0.25, color = "grey50") +
                  geom_abline(intercept = 5, size = 0.25, color = "grey50", linetype =3) +
                  geom_abline(intercept = -5, size = 0.25, color = "grey50", linetype =3) +
                  geom_point(colour = "grey50", size = 1.8) +
                  geom_point(aes(color = factor(background_color)), size = 1.6) + 
                  geom_text_repel(aes(label = Site), size = 1.5) + 
                  scale_color_manual(values = levels(factor(tall_o3$background_color)), guide = F) +
                  ylim(range(c(verify_all$`Obs conc`, verify_all$`MPCA conc`), na.rm = T)) +
                  xlim(range(c(verify_all$`Obs conc`, verify_all$`MPCA conc`), na.rm = T)) +
                  theme_bw() + 
                  theme(aspect.ratio = 1) +
                  facet_grid(. ~ pollutant)
                  #labs(title = "(- -5 AQI buffer- -)")
}

o3_line_plot <- filter(verify_all, !is.na(`Obs conc`), pollutant == "Ozone") %>%
                ggplot(aes(x = `Obs conc`, y = `MPCA conc`)) + 
                  geom_abline(intercept = 0, size = 0.25, color = "grey50") +
                  geom_abline(intercept = 5, size = 0.25, color = "grey50", linetype =3) +
                  geom_abline(intercept = -5, size = 0.25, color = "grey50", linetype =3) +
                  geom_point(colour = "grey50", size = 1.75) +
                  geom_point(aes(color = factor(background_color)), size = 1.6) + 
                  geom_text_repel(aes(label = Site), size = 1.75) + 
                  scale_color_manual(values = levels(factor(tall_o3$background_color)), guide = F) +
                  ylim(ozone_range) +
                  xlim(ozone_range) +
                  theme_bw() + 
                  theme_gray(base_size = 5) +
                  theme(aspect.ratio  = 1, 
                        plot.margin   = unit(c(0,0.5,0,0), "lines"),
                        plot.title    = element_text(size=7.5, color="grey20"),
                        panel.grid.major = element_line(color="grey94", size=0.3),
                        panel.grid.minor = element_line(color="grey96", size=0.25),
                        panel.background = element_rect(fill="grey99"),
                        axis.ticks    = element_blank(),
                        axis.text.x   = element_text(size=5),
                        axis.title.x  = element_text(size=5),
                        axis.text.y   = element_text(size=5),
                        axis.title.y  = element_text(size=5)) +
                  labs(title = "Ozone (ppb)", x = "Monitored", y = "MPCA forecast")


pm_line_plot <- filter(verify_all, !is.na(`Obs conc`), pollutant == "PM2.5") %>%
                ggplot(aes(x = `Obs conc`, y = `MPCA conc`)) + 
                  geom_abline(intercept = 0, size = 0.25, color = "grey50") +
                  geom_abline(intercept = 3, size = 0.25, color = "grey50", linetype = 3) +
                  geom_abline(intercept = -3, size = 0.25, color = "grey50", linetype = 3) +
                  geom_point(colour = "grey50", size = 1.75) +
                  geom_point(aes(color = factor(background_color)), size = 1.6) + 
                  geom_text_repel(aes(label = Site), size = 1.75) + 
                  scale_color_manual(values = levels(factor(tall_pm$background_color)), guide = F) +
                  ylim(pm_range) +
                  xlim(pm_range) +
                  theme_bw() + 
                  theme_gray(base_size = 5) + 
                  theme(aspect.ratio  = 1, 
                        plot.margin   = unit(c(0,0.5,0,0), "lines"),
                        plot.title    = element_text(size=7.5, color="grey20"),
                        panel.grid.major = element_line(color="grey94", size=0.3),
                        panel.grid.minor = element_line(color="grey96", size=0.25),
                        panel.background = element_rect(fill="grey99"),
                        axis.ticks    = element_blank(),
                        axis.text.x   = element_text(size=5),
                        axis.title.x  = element_text(size=5),
                        axis.text.y   = element_text(size=5),
                        axis.title.y  = element_text(size=5)) +
                  labs(title = "PM2.5 (ug/m3)", x = "Monitored", y = "MPCA forecast")


# Save to PNG image
png("C:/Users/dkvale/Desktop/fcst_regression.png", width = 1300, height = 700, res = 300)
# Set 2 plots per row
grid.arrange(o3_line_plot, pm_line_plot, ncol = 2) #print(line_plot + theme_gray(base_size = 4.5))
dev.off()

png("fcst_regression.png", width = 1300, height = 700, res = 300)
# Set 2 plots per row
grid.arrange(o3_line_plot, pm_line_plot, ncol = 2) #print(line_plot + theme_gray(base_size = 4.5))
dev.off()

#ggsave("fcst_regression.png")
#ggsave("C:/Users/dkvale/Desktop/fcst_regression.png")

verify_o3$background_color <- NULL
```
  
```{r echo=FALSE, message =FALSE, warning =FALSE, results='hide'}
# Leader board
#lead_board <- data_frame(Model              = c("Staniel Dirwin", "Dr Robot", "CMAQ"),
#                         `O3 accuracy (%)`  = c(100,100,100),
#                         `PM accuracy (%)`  = c(100,100,100),
#                         `O3 bias (ppb)`    = c(5,5,5),
#                         `PM bias (ug/m3)`  = c(1,1,1),
#                         `Forecasts (n)`    = c(0,0,0)) 
                             

# Load past results
lead_board <- read_csv("X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/Staff folders/Dorian/AQI/Verification/lead_board.csv")

#lead_board <- read_csv(paste0("X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/Staff folders/Dorian/AQI/Verification/Archive leaders/", Sys.Date()-1, "-lead_board.csv"))

#lead_board <- read_csv("X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/Staff folders/Dorian/AQI/Verification/lead_backup.csv")


# New performance metrics
## Dr. Robot
robot_cat_o3_frx <- tall_o3 %>% 
                    filter(model %in% c("Obs AQI","Model output"), !is.na(aqi)) %>%
                    group_by(Site) %>%
                    mutate(fcst_correct = identical(background_color[model == "Obs AQI"], 
                                                     background_color[model == "Model output"])) %>%
                    ungroup() %>%
                    summarize(n_obs    = sum(!is.na(aqi[model == "Obs AQI"])),
                               accuracy = 100 * sum(fcst_correct[model == "Obs AQI"], na.rm = T) / n_obs) %>%
                    .[1, "accuracy"] 

robot_cat_pm_frx <- tall_pm %>% 
                     filter(model %in% c("Obs AQI","Model output"), !is.na(aqi)) %>%
                     group_by(Site) %>%
                     mutate(fcst_correct = identical(background_color[model == "Obs AQI"], 
                                                     background_color[model == "Model output"])) %>%
                     ungroup() %>%
                     summarize(n_obs    = sum(!is.na(aqi[model == "Obs AQI"])),
                               accuracy = 100 * sum(fcst_correct[model == "Obs AQI"], na.rm = T) / n_obs) %>%
                     .[1, "accuracy"]

robot_mean_o3_diff <- mean(abs(filter(tall_o3, !is.na(aqi), model == "Model output")$`conc_diff (ppb)`), na.rm = T) 

robot_mean_pm_diff <- mean(abs(filter(tall_pm, !is.na(aqi), model == "Model output")$`conc_diff (ug/m3)`), na.rm = T) 

## CMAQ
cmaq_cat_o3_frx <- tall_o3 %>% 
                    filter(model %in% c("Obs AQI", "CMAQ forecast"), !is.na(aqi)) %>%
                    group_by(Site) %>%
                    mutate(fcst_correct = identical(background_color[model == "Obs AQI"], 
                           background_color[model == "CMAQ forecast"])) %>%
                    ungroup() %>%
                    summarize(n_obs    = sum(!is.na(aqi[model == "Obs AQI"])),
                              accuracy = 100 * sum(fcst_correct[model == "Obs AQI"], na.rm = T) / n_obs)

cmaq_mean_o3_diff <- mean(abs(filter(tall_o3, !is.na(aqi), model == "CMAQ forecast")$`conc_diff (ppb)`), na.rm = T) 

## New performance table
new_stats <- data_frame(Model                 = c("Staniel Dirwin", "Dr Robot", "CMAQ"),
                        `new O3 accuracy (%)` = c(round(o3_cat_frx * 100), robot_cat_o3_frx$accuracy[1], cmaq_cat_o3_frx$accuracy[1]),
                        `new O3 bias (ppb)`   = c(mean_o3_diff, robot_mean_o3_diff, cmaq_mean_o3_diff),
                        `new PM accuracy (%)` = c(round(pm_cat_frx * 100), robot_cat_pm_frx$accuracy, NA),
                        `new PM bias (ug/m3)` = c(mean_pm_diff, robot_mean_pm_diff, NA),
                        new_obs               = c(1, 1, min(1, cmaq_cat_o3_frx$n_obs[1])))

# Update performance
lead_board <- left_join(new_stats, lead_board)

lead_board <- lead_board %>% 
              mutate(`Forecasts (n)`    = `Forecasts (n)` + new_obs,
                     `O3 accuracy (%)`  = ((`O3 accuracy (%)` * (`Forecasts (n)` - 1) + `new O3 accuracy (%)` * new_obs) / 
                                          max(1, `Forecasts (n)`)),
                     `PM accuracy (%)`  = ((`PM accuracy (%)` * (`Forecasts (n)` - 1) + `new PM accuracy (%)` * new_obs) / 
                                          max(1, `Forecasts (n)`)),
                     `O3 bias (ppb)`    = ((`O3 bias (ppb)` * (`Forecasts (n)` - 1) + `new O3 bias (ppb)` * new_obs) / 
                                          max(1, `Forecasts (n)`)),
                     `PM bias (ug/m3)`  = ((`PM bias (ug/m3)` * (`Forecasts (n)` - 1) + `new PM bias (ug/m3)` * new_obs) / 
                                          max(1, `Forecasts (n)`)))

# Create web table
margin_right <- function(i) {
    formatter("span", style = x ~ style("padding-right"  = paste0(i, "px"),
                                        digits(x, 2)))
}


# Yesterday's performance
yest_board <- select(lead_board, c(Model, `new O3 accuracy (%)`, `new O3 bias (ppb)`, `new PM accuracy (%)`, `new PM bias (ug/m3)`))

names(yest_board) <- gsub("new ", "", names(yest_board))

names(yest_board) <-  c("Model", "O3 accuracy (%)", "O3 bias (ppb)", "PM accuracy (%)", "PM bias (ug/m3)")

yest_board <- cbind(yest_board, data_frame("Date of forecast" = c(fcast_date, fcast_date, cmaq_date)))

yest_board <- formattable(yest_board,
                          list(Model             = margin_right(24),
                               `O3 accuracy (%)` = margin_right(104),
                               `O3 bias (ppb)`   = margin_right(84),
                               `PM accuracy (%)` = margin_right(106),
                               `PM bias (ug/m3)` = margin_right(100)),
                          align = c("l","l","l","l","l"), digits = 1)



# Total running performance
lead_board <- select(lead_board, c(Model, `O3 accuracy (%)`,`O3 bias (ppb)`, `PM accuracy (%)`, `PM bias (ug/m3)`, `Forecasts (n)`))

# Archive updated performance
write_csv(lead_board, "X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/Staff folders/Dorian/AQI/Verification/lead_board.csv")

# Backup file
write_csv(lead_board, paste0("X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/Staff folders/Dorian/AQI/Verification/Archive leaders/", Sys.Date(), "-lead_board.csv"))


lead_board <- formattable(lead_board,
                          list(Model             = margin_right(24),
                               `O3 accuracy (%)` = margin_right(104),
                               `O3 bias (ppb)`   = margin_right(84),
                               `PM accuracy (%)` = margin_right(106),
                               `PM bias (ug/m3)` = margin_right(100)),
                          align = c("l","l","l","l","l","l"), digits = 1)


# Save web tables
saveRDS(yest_board, "yesterday_board.rdata")
saveRDS(lead_board, "leader_board.rdata")
```
  
  
```{r echo=FALSE, message =FALSE, warning =FALSE}
# Update group names
verify_all$Group <- ifelse(verify_all$Group  == "MSP", "MSP-STP", verify_all$Group)

# Add paddding to columns
verify_all$Site <- paste0(verify_all$Site, "    ")

# Web format
margin_left <- function(i) {
  formatter("span", style = x ~ style("padding-left"  = paste0(i, "px"),
                                      "color"         = ifelse(is.na(x), "white", "black"))
            )
}


col_format <- function(i, param) {
  
  formatter("span", 
            style = x ~ style("padding-left"     = "36px",
                              "padding-right"    = "36px",
                              "margin-right"     = paste0(i, "px"),
                              "font-weight"      = 600,
                              "background-color" = conc2color(x, param),
                              "color"            = ifelse(is.na(x), "white", "black"),
                              digits(x, 2)
                              )
                    )
}


names(verify_all) <- c("Site", "Group", "Obs count", "Obs AQI", "MPCA AQI", "Model AQI", "CMAQ AQI", "pollutant", "background_color", "Monitored", "MPCA fcast", "Model output", "CMAQ fcast")

# Replace NAs with blanks "  "
#options(knitr.kable.NA = '  ')
#verify_all[is.na(verify_all)] <- "  "


# Drop model output value unless different than MPCA forecast
verify_all$`Model output` <- ifelse(verify_all$`MPCA fcast` == verify_all$`Model output`, NA, verify_all$`Model output`)

# Save web tables
# Ozone
verify_o3 <- formattable(filter(verify_all, pollutant == "Ozone")[ , -c(4:9)],
                         list(Site            = margin_right(23),
                              Group           = margin_right(20),
                              `Obs count`     = margin_right(65),
                              `Monitored`     = col_format(15, "ozone"),
                              `MPCA fcast`    = col_format(15, "ozone"),
                              `Model output`  = col_format(15, "ozone"),
                              `CMAQ fcast`    = col_format(15, "ozone")),
                          align = c("l","l","l","l","l","l","l"), digits = 1)


saveRDS(verify_o3, "o3_table.rdata")


# PM table
verify_pm <- formattable(filter(verify_all, pollutant == "PM2.5")[ , -c(4:9,13)],
                         list(Site            = margin_right(23),
                              Group           = margin_right(20),
                              `Obs count`     = margin_right(65),
                              `Monitored`     = col_format(15, "pm25"),
                              `MPCA fcast`    = col_format(15, "pm25"),
                              `Model output`  = col_format(15, "pm25")),
                          align = c("l","l","l","l","l","l"), digits = 1)

saveRDS(verify_pm, "pm_table.rdata")

```
  
<div style="margin-top: 20px;">
### Yesterday&#39;s model performance
</div>

<div style="margin-top: -10px;">
How did Staniel Dirwin do? The accuracy of the next-day forecast was 
__`r round(100 * o3_cat_frx)`%__
(`r sum(filter(tall_o3, !is.na(aqi), model == 'Obs AQI')$fcst_correct, na.rm = T)`/`r nrow(filter(tall_o3, !is.na(aqi), model == 'Obs AQI'))`)
for ozone and
__`r round(100 * pm_cat_frx)`%__
(`r sum(filter(tall_pm, !is.na(aqi), model == 'Obs AQI')$fcst_correct, na.rm = T)`/`r nrow(filter(tall_pm, !is.na(aqi), model == 'Obs AQI'))`)
for PM2.5. 
</div> 

<div style="margin-top: -8px; margin-left: 24px;">
```{r, echo = F, warning = F, message = F}
yest_board <- readRDS('yesterday_board.rdata')
yest_board
```
</div>
  
  
### Overall model performance for next-day forecasts
<div style="margin-top: -10px;">
Dr Robot is getting smarter everyday.
```{r echo=F, eval=F}
#Staniel Dirwin is currently out performing Dr Robot, but Dr Robot gets smarter everyday. Does __Staniel__?

#Dr Robot is winning everything. The Brain is pleased.
````
</div>

<div style="margin-top: -8px; margin-left: 24px;">
```{r, echo = F, warning = F, message = F}
lead_board <- readRDS('leader_board.rdata')
lead_board
```
</div>
  
  
### MPCA forecast vs Monitored actuals 
<div style = "margin-top: -20px; margin-left: 8px;">
<img src="fcst_regression.png" width="1000" height="500"> 
</div>   


<div style="margin-top: -12px">
### Ozone _(ppb)_
</div>

<div style="margin-top: -18px; margin-left: 18px;">
```{r, echo = F, warning = F, message = F}
o3_df <- readRDS('o3_table.rdata')
o3_df
```
</div>


### PM-2.5 _(ug/m3)_
<div style="margin-top: -18px; margin-left: 18px;">
```{r, echo = F, warning = F, message = F}
pm_df <- readRDS('pm_table.rdata')
pm_df
```
</div>
  
